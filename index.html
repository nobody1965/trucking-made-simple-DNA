<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trucking Made Simple</title>

  <style>
    :root{
      --bg:#0b0c10;
      --card:#121420;
      --text:#e9e9f1;
      --muted:#aeb2c7;
      --line:#242844;
      --pill:#1a1f34;
      --pillActive:#2a3270;
      --btn:#1a1f34;
      --btnHover:#232a4a;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    /* Top scroll tabs (YouTube-style) */
    .topTabs{
      position: sticky;
      top: 0;
      z-index: 50;
      display:flex;
      gap:8px;
      padding:10px;
      overflow-x:auto;
      background: rgba(11,12,16,.95);
      border-bottom:1px solid var(--line);
      -webkit-overflow-scrolling: touch;
    }
    .tabBtn{
      flex: 0 0 auto;
      border:1px solid var(--line);
      background:var(--pill);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
      font-weight:600;
    }
    .tabBtn.active{
      background:var(--pillActive);
      border-color:#3c46a8;
    }

    /* Main card */
    .wrap{ max-width:980px; margin: 14px auto; padding: 0 12px; }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .headerBar{ margin-bottom:8px; }
    h1{ margin:4px 0 0; font-size:22px; }
    .sub{ color:var(--muted); margin:6px 0 10px; font-size:14px; }
    .headerDivider, .divider{ height:1px; background:var(--line); margin:12px 0; }

    .badge{
      display:inline-block;
      background:#0f1326;
      border:1px solid var(--line);
      padding:8px 10px;
      border-radius:999px;
      color:var(--muted);
      font-size:12px;
    }

    /* Pages */
    .tabPage{ display:none; }
    .tabPage.activePage{ display:block; }

    /* Sections (open/close) */
    .sectionBtn{
      width:100%;
      text-align:left;
      border:1px solid var(--line);
      background:var(--btn);
      color:var(--text);
      padding:12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      margin-top:10px;
    }
    .sectionBtn:hover{ background:var(--btnHover); }

    .sectionContent{
      display:none;
      border:1px dashed var(--line);
      border-radius:12px;
      padding:12px;
      margin-top:10px;
      background:#0f1222;
    }
    .sectionContent.open{ display:block; }

    .note{
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }

    /* Simple grid for inputs */
    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:12px;
      margin-top:12px;
    }
    label{ display:block; font-weight:700; margin-bottom:6px; }
    input{
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid var(--line);
      background:#0b0e1c;
      color:var(--text);
      font-size:16px;
    }
    input[readonly]{ opacity:.85; }

    @media (max-width:700px){
      .grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>

  <!-- TOP SCROLL BAR -->
  <div class="topTabs" id="topTabs">
    <button class="tabBtn active" data-target="settingsPage">Settings</button>
    <button class="tabBtn" data-target="tripPage">Trip</button>
    <button class="tabBtn" data-target="scenarioPage">Scenario</button>
    <button class="tabBtn" data-target="actualPage">Actual</button>
    <button class="tabBtn" data-target="budgetPage">Budget</button>
    <button class="tabBtn" data-target="reservesPage">Reserves</button>
    <button class="tabBtn" data-target="totalsPage">Totals</button>
    <button class="tabBtn" data-target="dnaPage">Yearly DNA</button>
    <button class="tabBtn" data-target="otraffPage">O.T.R.A.F.F</button>
    <button class="tabBtn" data-target="plPage">Profit / Loss</button>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="headerBar">
        <h1>Trucking Made Simple</h1>
        <div class="sub">Scenario Calculator ‚Ä¢ Revenue ‚Ä¢ O.T.R.A.F.F ‚Ä¢ Time Away From Family</div>
        <div class="headerDivider"></div>
      </div>

      <!-- ===================== TAB PAGES START (ALL SIBLINGS) ===================== -->

<div id="settingsPage" class="tabPage activePage">
  <h3>Settings</h3>

  <div class="note">
    üîí Settings control <strong>preferences and defaults only</strong>.<br>
    They do <strong>not</strong> change Scenario math, formulas, or historical truth.
  </div>

  <div class="divider"></div>

  <!-- ================= BUSINESS RESERVE DEFAULTS ================= -->
  <button class="sectionBtn" type="button" onclick="toggleSection('settingsBusinessReserveSection')">
    üíº Business Reserve Defaults (tap to open / close)
  </button>

  <div id="settingsBusinessReserveSection" class="sectionContent">
    <div class="note">
      These are your <strong>target rules</strong> for how you like to run your truck.<br>
      Scenario and Actual calculations may differ based on reality.
    </div>

    <div class="grid">
      <div>
        <label>Default Business Reserve %</label>
        <input id="setBusinessReservePct" type="number" placeholder="e.g. 18" />
        <div class="note">Used as a starting assumption only.</div>
      </div>

      <div>
        <label>Default Maintenance Slice %</label>
        <input id="setMaintenancePct" type="number" placeholder="e.g. 8" />
        <div class="note">Tires ‚Ä¢ oil ‚Ä¢ breakdown buffer.</div>
      </div>
    </div>
  </div>

  <!-- ================= DISPLAY & UX ================= -->
  <button class="sectionBtn" type="button" onclick="toggleSection('settingsDisplaySection')">
    üñ•Ô∏è Display & UX (tap to open / close)
  </button>

  <div id="settingsDisplaySection" class="sectionContent">
    <div class="note">
      These settings only affect how information is shown.
    </div>

    <div class="grid">
      <div>
        <label>
          <input type="checkbox" id="setDarkMode">
          Dark Mode
        </label>
      </div>

      <div>
        <label>
          <input type="checkbox" id="setTooltips" checked>
          Show explanations & tips
        </label>
      </div>
    </div>
  </div>

  <!-- ================= LOCK NOTICE ================= -->
  <div class="divider"></div>

  <div class="note">
    üîê <strong>Plain Lock Rule:</strong><br>
    If it affects money math, time math, or O.T.R.A.F.F ‚Äî it does not belong in Settings.

    <!-- ================= PLAIN LOCK NOTICE (HARD FENCE) ================= -->
  <div class="divider"></div>

  <div class="lockBox">
    <div class="lockTitle">üîí Plain Lock ‚Äî What Settings Can‚Äôt Change</div>
    <div class="note">
      Settings are <strong>preferences + defaults only</strong>.<br>
      They cannot modify:
      <ul class="lockList">
        <li>Scenario math / formulas</li>
        <li>O.T.R.A.F.F calculation</li>
        <li>Actual history / totals</li>
        <li>Locked constants used by the Blueprint</li>
      </ul>
      If it affects money math, time math, or truth ‚Äî it does not belong in Settings.
    </div>
  </div>

  <!-- ================= SAVE / RESET (PREFERENCES ONLY) ================= -->
  <div class="saveRow">
    <button class="sectionBtn" type="button" onclick="saveSettingsPlainLock()">
      üíæ Save Settings (Preferences Only)
    </button>

    <button class="sectionBtn" type="button" onclick="resetSettingsPlainLock()">
      ‚ôªÔ∏è Reset to Defaults
    </button>

    <div id="settingsSavedMsg" class="note" style="margin-top:8px;"></div>
  </div>

  <!-- ================= STORAGE KEYS (VERSIONED) ================= -->
  <!--
    PC-SETTINGS-LOCK v1.0 (storage)
    storageKey: TMS_SETTINGS_v1

    fields:
      - businessReservePct (number)
      - maintenancePct (number)
      - darkMode (boolean)
      - tooltips (boolean)

    rule:
      - Settings may store preferences only.
      - Settings never write to Scenario/Actual calculations or history.
  -->
  </div>
</div>

      <div id="tripPage" class="tabPage">
        <span class="badge">Locked constants: Avg Speed = 65 mph ‚Ä¢ DOT break = 30 min after 8 driving hours ‚Ä¢ Fuel stop min = 15 min</span>
        <div class="divider"></div>

        <h3>Trip (Data Entry)</h3>

        <div class="grid">
          <div>
            <label>Deadhead Miles</label>
            <input id="deadheadMiles" type="number" value="0" oninput="updateTotalMilesFromParts()" />
          </div>

          <div>
            <label>Loaded Miles</label>
            <input id="loadedMiles" type="number" value="0" oninput="updateTotalMilesFromParts()" />
          </div>

          <div>
            <label>Return Miles</label>
            <input id="returnMiles" type="number" value="0" oninput="updateTotalMilesFromParts()" />
          </div>

          <div>
            <label>Total Miles (auto)</label>
            <input id="totalMiles" type="number" readonly />
            <div class="note">Deadhead + Loaded + Return</div>

            <div class="divider"></div>

          <button class="sectionBtn" type="button" onclick="saveTripPlainLock()">
          üíæ Save Trip Miles (Data Entry Only)
          </button>

          <button class="sectionBtn" type="button" onclick="resetTripPlainLock()">
          ‚ôªÔ∏è Reset Trip Miles
          </button>

          <div id="tripSavedMsg" class="note" style="margin-top:8px;"></div>
          </div>
        </div>

        <button class="sectionBtn" type="button" onclick="toggleSection('tripHelpSection')">
          üß† What this means (tap to open / close)
        </button>
        <div id="tripHelpSection" class="sectionContent">
          <div class="note">
            Trip miles drive: fuel use, time away, and what your true hourly value is (O.T.R.A.F.F).
          </div>
        </div>
      </div>

      <div id="scenarioPage" class="tabPage">
        <h3>Scenario</h3>
      <div class="note">
  Scenario = estimate only. Editable assumptions ‚Üí locked truth.
</div>

<!-- ================= INPUTS (ONLY EDITABLE AREA) ================= -->
<div class="sectionContent open">
  <div class="note"><strong>Editable Inputs (Scenario Only)</strong></div>

  <div class="grid">
    <div>
      <label>Revenue ($)</label>
      <input id="scenRevenue" type="number" />
    </div>

    <div>
      <label>Deadhead Miles</label>
      <input id="scenDeadhead" type="number" />
    </div>

    <div>
      <label>Loaded Miles</label>
      <input id="scenLoaded" type="number" />
    </div>

    <div>
      <label>Return-to-Home Miles</label>
      <input id="scenReturn" type="number" />
    </div>
  </div>
</div>

<!-- ================= READ-ONLY TRUTH ================= -->
<div id="scenarioOutput" class="sectionContent open">
  <div class="note"><strong>Auto-Calculated (Read-Only)</strong></div>

  <div class="grid">
    <div>
      <label>Total Miles</label>
      <input id="scenTotalMiles" readonly />
    </div>

    <div>
      <label>Estimated MPG (Lifetime)</label>
      <input id="scenMPG" readonly />
    </div>

    <div>
      <label>Estimated Fuel Cost ($)</label>
      <input id="scenFuelCost" readonly />
    </div>

    <div>
      <label>Total Hours Away</label>
      <input id="scenHours" readonly />
    </div>

    <div>
      <label>O.T.R.A.F.F ($/hr)</label>
      <input id="scenOTRAFF" readonly />
    </div>

    <div>
      <label>Scenario Net ($)</label>
      <input id="scenNet" readonly />
    </div>
  </div>

  <div class="note" id="scenarioMessage"></div>
</div>

        <button class="sectionBtn" type="button" onclick="toggleSection('scenarioReserveSection')">
          üß∞ Scenario Reserves (tap to open / close)
        </button>
        <div id="scenarioReserveSection" class="sectionContent">
          <div class="note">Maintenance ‚Ä¢ Tax ‚Ä¢ Peace-of-Mind reserves calculated from Scenario.</div>
        </div>
      </div>

<div id="actualPage" class="tabPage">
  <h3>Actual</h3>
  <div class="note">
    üîí Actual = truth. <strong>Only Actual</strong> updates history/totals and Lifetime MPG.<br>
    üîí Inputs unlock only when <strong>Status = Delivered</strong>.
  </div>

  <div class="divider"></div>

  <!-- STATUS GATE (LOCK) -->
  <div class="sectionContent open">
    <div class="note"><strong>Status (LOCK GATE)</strong></div>

    <div class="grid">
      <div>
        <label>Status</label>
        <input id="actStatus" type="text" readonly />
        <div class="note">Locked until you tap ‚ÄúMark Delivered‚Äù.</div>
      </div>

      <div>
        <label>Delivered Timestamp</label>
        <input id="actDeliveredAt" type="text" readonly />
        <div class="note">Saved automatically when delivered.</div>
      </div>
    </div>

    <button class="sectionBtn" type="button" onclick="markDeliveredPlainLock()">
      ‚úÖ Mark Delivered (Unlock Actual)
    </button>

    <div id="actualGateMsg" class="note" style="margin-top:8px;"></div>
  </div>

  <div class="divider"></div>

  <!-- ACTUAL INPUTS (LOCKED UNTIL DELIVERED) -->
  <div class="sectionContent open">
    <div class="note"><strong>Actual Inputs (Truth)</strong></div>

    <div class="grid">
      <div>
        <label>Revenue ($)</label>
        <input id="actRevenue" type="number" />
      </div>

      <div>
        <label>Deadhead Miles</label>
        <input id="actDeadhead" type="number" />
      </div>

      <div>
        <label>Loaded Miles</label>
        <input id="actLoaded" type="number" />
      </div>

      <div>
        <label>Return-to-Home Miles</label>
        <input id="actReturn" type="number" />
      </div>

      <div>
        <label>Total Miles (auto)</label>
        <input id="actTotalMiles" type="number" readonly />
        <div class="note">Deadhead + Loaded + Return</div>
      </div>

      <div>
        <label>Total Gallons Purchased</label>
        <input id="actGallons" type="number" />
        <div class="note">Used to update Lifetime MPG.</div>
      </div>

      <div>
        <label>Avg Fuel Price ($/gal)</label>
        <input id="actFuelPrice" type="number" />
      </div>

      <div>
        <label>Detention (hours)</label>
        <input id="actDetentionHours" type="number" />
      </div>
    </div>

    <button class="sectionBtn" type="button" onclick="saveActualPlainLock()">
      üíæ Save Actual (Truth Only)
    </button>

    <button class="sectionBtn" type="button" onclick="resetActualPlainLock()">
      ‚ôªÔ∏è Reset Actual
    </button>

    <div id="actualSavedMsg" class="note" style="margin-top:8px;"></div>
  </div>

  <div class="divider"></div>

  <!-- READ-ONLY OUTPUTS (AUTO) -->
  <div class="sectionContent open">
    <div class="note"><strong>Actual Outputs (Read-Only)</strong></div>

    <div class="grid">
      <div>
        <label>Fuel Cost ($)</label>
        <input id="actFuelCost" readonly />
      </div>

      <div>
        <label>Lifetime MPG (Updated from Actual)</label>
        <input id="actLifetimeMPG" readonly />
      </div>
    </div>

    <div class="note" id="actualMessage"></div>
  </div>

  <button class="sectionBtn" type="button" onclick="toggleSection('actualReserveSection')">
    ‚úÖ Actual Reserves (tap to open / close)
  </button>
  <div id="actualReserveSection" class="sectionContent">
    <div class="note">Actual reserve deductions come from what really happened.</div>
  </div>
</div>

<div id="budgetPage" class="tabPage">
  <h3>Budget</h3>

  <div class="note">
    üîí Budget = two ledgers inside one tab.<br>
    üè† Household protects life. üöõ Business protects the truck.<br>
    Values here are stored as budgets only ‚Äî they do not rewrite Scenario/Actual truth.
  </div>

  <div class="divider"></div>

  <!-- ===================== HOUSEHOLD ===================== -->
  <button class="sectionBtn" type="button" onclick="toggleSection('budgetHouseholdSection')">
    üè† Household Budget (tap to open / close)
  </button>

  <div id="budgetHouseholdSection" class="sectionContent">
    <div class="note">
      Household = what the family needs monthly even if the truck makes $0 this week.
    </div>

    <div class="grid">
      <div>
        <label>Housing ($/mo)</label>
        <input id="hhHousing" type="number" placeholder="0" />
      </div>

      <div>
        <label>Utilities ($/mo)</label>
        <input id="hhUtilities" type="number" placeholder="0" />
      </div>

      <div>
        <label>Food ($/mo)</label>
        <input id="hhFood" type="number" placeholder="0" />
      </div>

      <div>
        <label>Household Insurance ($/mo)</label>
        <input id="hhInsurance" type="number" placeholder="0" />
      </div>

      <div>
        <label>Phone / Internet ($/mo)</label>
        <input id="hhPhoneInternet" type="number" placeholder="0" />
      </div>

      <div>
        <label>Family / Child Support ($/mo)</label>
        <input id="hhChildSupport" type="number" placeholder="0" />
      </div>

      <div>
        <label>Household Transportation ($/mo)</label>
        <input id="hhTransport" type="number" placeholder="0" />
      </div>

      <div>
        <label>Household Buffer ($/mo)</label>
        <input id="hhBuffer" type="number" placeholder="0" />
      </div>
    </div>

    <div class="divider"></div>

    <div class="grid">
      <div>
        <label>Household Total ($/mo) (auto)</label>
        <input id="hhTotalMonthly" readonly />
      </div>

      <div>
        <label>Household Total ($/wk) (auto)</label>
        <input id="hhTotalWeekly" readonly />
      </div>

      <div>
        <label>Household Total ($/day) (auto)</label>
        <input id="hhTotalDaily" readonly />
      </div>

      <div>
        <label>Household Total ($/hr away) (auto)</label>
        <input id="hhTotalHourlyAway" readonly />
        <div class="note">Uses 24 hrs/day for a simple v1.0 baseline.</div>
      </div>
    </div>

    <div class="divider"></div>

    <button class="sectionBtn" type="button" onclick="saveBudgetPlainLock()">
      üíæ Save Budget (Household + Business)
    </button>

    <button class="sectionBtn" type="button" onclick="resetBudgetPlainLock()">
      ‚ôªÔ∏è Reset Budget
    </button>

    <div id="budgetSavedMsg" class="note" style="margin-top:8px;"></div>
  </div>

  <!-- ===================== BUSINESS ===================== -->
  <button class="sectionBtn" type="button" onclick="toggleSection('budgetBusinessSection')">
    üöõ Business Budget (tap to open / close)
  </button>

  <div id="budgetBusinessSection" class="sectionContent">
    <div class="note">
      Business = fixed monthly costs + buffers that exist even if the truck is parked.
    </div>

    <div class="grid">
      <div>
        <label>Truck Payment ($/mo)</label>
        <input id="bizTruckPayment" type="number" placeholder="0" />
      </div>

      <div>
        <label>Truck Insurance ($/mo)</label>
        <input id="bizInsurance" type="number" placeholder="0" />
      </div>

      <div>
        <label>Plates / Permits ($/mo)</label>
        <input id="bizPlatesPermits" type="number" placeholder="0" />
      </div>

      <div>
        <label>ELD / Subscriptions ($/mo)</label>
        <input id="bizEldSubs" type="number" placeholder="0" />
      </div>

      <div>
        <label>Accounting / Admin ($/mo)</label>
        <input id="bizAdmin" type="number" placeholder="0" />
      </div>

      <div>
        <label>Maintenance Reserve ($/mo)</label>
        <input id="bizMaintenanceReserve" type="number" placeholder="0" />
      </div>

      <div>
        <label>Tire Reserve ($/mo)</label>
        <input id="bizTireReserve" type="number" placeholder="0" />
      </div>

      <div>
        <label>Breakdown Buffer ($/mo)</label>
        <input id="bizBreakdownBuffer" type="number" placeholder="0" />
      </div>
    </div>

    <div class="divider"></div>

    <div class="grid">
      <div>
        <label>Business Total ($/mo) (auto)</label>
        <input id="bizTotalMonthly" readonly />
      </div>

      <div>
        <label>Business Total ($/wk) (auto)</label>
        <input id="bizTotalWeekly" readonly />
      </div>

      <div>
        <label>Business Total ($/day) (auto)</label>
        <input id="bizTotalDaily" readonly />
      </div>

      <div>
        <label>Business Total ($/hr away) (auto)</label>
        <input id="bizTotalHourlyAway" readonly />
      </div>
    </div>

    <div class="divider"></div>

    <div class="grid">
      <div>
        <label>Combined Total ($/mo) (auto)</label>
        <input id="budgetCombinedMonthly" readonly />
      </div>

      <div>
        <label>Combined Total ($/hr away) (auto)</label>
        <input id="budgetCombinedHourlyAway" readonly />
      </div>
    </div>
  </div>

  <!-- ===================== STORAGE NOTE ===================== -->
  <!--
    PC-BUDGET-DUAL-LEDGER v1.0 (storage)
    storageKey: TMS_BUDGET_v1
    Household fields: hh*
    Business fields: biz*
    Rule: Budget stores values + derived rollups only.
    It does NOT write to Scenario/Actual truth directly in v1.0.
  -->
</div>

      <div id="totalsPage" class="tabPage">
        <h3>Totals</h3>
        <div class="note">Monthly + YTD totals (Actual only).</div>
      </div>

      <div id="dnaPage" class="tabPage">
        <h3>Yearly DNA</h3>
        <div class="note">Your yearly patterns, strengths, and money leaks.</div>
      </div>

      <div id="otraffPage" class="tabPage">
        <h3>O.T.R.A.F.F</h3>
        <div class="note">On The Road Away From Family ‚Äî net revenue √∑ hours away.</div>
      </div>

      <div id="plPage" class="tabPage">
        <h3>Profit / Loss</h3>
        <div class="note">P/L view (Actual only).</div>
      </div>

      <!-- ===================== TAB PAGES END ===================== -->

    </div>
  </div>

  <script>
    // ---------- Helpers ----------
    function n(id){
      const el = document.getElementById(id);
      if (!el) return 0;
      const v = parseFloat(el.value);
      return isFinite(v) ? v : 0;
    }
    function setVal(id, v){
      const el = document.getElementById(id);
      if (el) el.value = v;
    }

    // ---------- Section Toggle (open/close) ----------
    function toggleSection(id){
      const section = document.getElementById(id);
      if (!section) return;
      section.classList.toggle("open");
    }

// ---------- Tabs ----------
document.addEventListener("DOMContentLoaded", () => {
  const tabButtons = Array.from(document.querySelectorAll(".tabBtn"));
  const tabPages   = Array.from(document.querySelectorAll(".tabPage"));

  function setActiveTab(targetId){
    tabButtons.forEach(b => b.classList.remove("active"));
    tabPages.forEach(p => p.classList.remove("activePage"));

    const btn  = tabButtons.find(b => b.dataset.target === targetId);
    const page = document.getElementById(targetId);

    if (btn)  btn.classList.add("active");
    if (page) page.classList.add("activePage");

    // üîí AUTO-RUN SCENARIO WHEN SCENARIO TAB BECOMES ACTIVE
    if (targetId === "scenarioPage"){
      runScenario();
    }
  }

  // üîó CLICK HANDLERS (THIS IS WHAT MAKES TABS CLICKABLE)
  tabButtons.forEach(btn => {
    btn.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      const targetId = btn.dataset.target;
      if (!targetId) return;
      setActiveTab(targetId);
      window.scrollTo({ top: 0, behavior: "smooth" });
    }, { passive:false });
  });

  // Default tab (uses whichever button is marked .active first)
  const defaultTarget =
    document.querySelector(".tabBtn.active")?.dataset.target ||
    tabButtons[0]?.dataset.target;

  if (defaultTarget) setActiveTab(defaultTarget);

  // initialize miles
  updateTotalMilesFromParts();

    // üîÅ AUTO-RECALCULATE SCENARIO WHEN INPUTS CHANGE
  ["scenRevenue","scenDeadhead","scenLoaded","scenReturn"].forEach(id => {
    const el = document.getElementById(id);
    if (el){
      el.addEventListener("input", runScenario);
    }
  });
});
    
    // ---------- Example Trip calc ----------
    function updateTotalMilesFromParts(){
      const total = n("deadheadMiles") + n("loadedMiles") + n("returnMiles");
      setVal("totalMiles", total);
    }

const SCENARIO_PLAIN_CODE = {
  avgSpeed: 65,            // mph
  fuelPrice: 3.75,         // placeholder (later auto-pull)
  lifetimeMPG: 6.8,        // placeholder lifetime actual
  fuelStopMinutes: 15,
  dotBreakHours: 8,
  reserveRate: 0.18        // total reserves
};

function runScenario(){
  // --- Editable inputs ---
  const revenue   = n("scenRevenue");
  const deadhead  = n("scenDeadhead");
  const loaded    = n("scenLoaded");
  const rtn       = n("scenReturn");

  // --- Total miles ---
  const totalMiles = deadhead + loaded + rtn;
  setVal("scenTotalMiles", totalMiles);

  if (totalMiles <= 0 || revenue <= 0){
    document.getElementById("scenarioMessage").textContent =
      "Enter revenue and miles to evaluate Scenario.";
    clearScenarioOutputs();
    return;
  }

  // --- MPG (locked from lifetime actual) ---
  const mpg = SCENARIO_PLAIN_CODE.lifetimeMPG;
  setVal("scenMPG", mpg.toFixed(2));

  // --- Fuel cost ---
  const fuelCost =
    (totalMiles / mpg) * SCENARIO_PLAIN_CODE.fuelPrice;
  setVal("scenFuelCost", fuelCost.toFixed(2));

  // --- Time calculation ---
  const driveHours = totalMiles / SCENARIO_PLAIN_CODE.avgSpeed;
  const dotBreaks =
    Math.floor(driveHours / SCENARIO_PLAIN_CODE.dotBreakHours) * 0.5;
  const fuelStops =
    Math.max(1, Math.floor(totalMiles / 500)) *
    (SCENARIO_PLAIN_CODE.fuelStopMinutes / 60);

  const totalHours = driveHours + dotBreaks + fuelStops;
  setVal("scenHours", totalHours.toFixed(2));

  // --- Net + OTRAF ---
  const reserves = revenue * SCENARIO_PLAIN_CODE.reserveRate;
  const net = revenue - fuelCost - reserves;
  const otraff = net / totalHours;

  setVal("scenNet", net.toFixed(2));
  setVal("scenOTRAFF", otraff.toFixed(2));

  document.getElementById("scenarioMessage").textContent =
    "Scenario calculated automatically (estimate only).";
}

function clearScenarioOutputs(){
  [
    "scenTotalMiles",
    "scenMPG",
    "scenFuelCost",
    "scenHours",
    "scenOTRAFF",
    "scenNet"
  ].forEach(id => setVal(id, ""));
}
    
// =====================
// üîí PLAIN LOCK SETTINGS v1.0 (PREFERENCES ONLY)
// =====================
const TMS_SETTINGS_STORAGE_KEY = "TMS_SETTINGS_v1";

const TMS_SETTINGS_DEFAULTS = {
  businessReservePct: 18,
  maintenancePct: 8,
  darkMode: false,
  tooltips: true
};

function getSettingsInputs(){
  return {
    businessReservePctEl: document.getElementById("setBusinessReservePct"),
    maintenancePctEl: document.getElementById("setMaintenancePct"),
    darkModeEl: document.getElementById("setDarkMode"),
    tooltipsEl: document.getElementById("setTooltips"),
    msgEl: document.getElementById("settingsSavedMsg")
  };
}

function loadSettingsPlainLock(){
  const { businessReservePctEl, maintenancePctEl, darkModeEl, tooltipsEl } = getSettingsInputs();
  if (!businessReservePctEl || !maintenancePctEl || !darkModeEl || !tooltipsEl) return;

  let saved = null;
  try {
    saved = JSON.parse(localStorage.getItem(TMS_SETTINGS_STORAGE_KEY) || "null");
  } catch (e) {
    saved = null;
  }

  const s = { ...TMS_SETTINGS_DEFAULTS, ...(saved || {}) };

  businessReservePctEl.value = s.businessReservePct;
  maintenancePctEl.value = s.maintenancePct;
  darkModeEl.checked = !!s.darkMode;
  tooltipsEl.checked = !!s.tooltips;

  // Optional UI application (safe)
  document.body.classList.toggle("darkMode", !!s.darkMode);
}

function saveSettingsPlainLock(){
  const { businessReservePctEl, maintenancePctEl, darkModeEl, tooltipsEl, msgEl } = getSettingsInputs();
  if (!businessReservePctEl || !maintenancePctEl || !darkModeEl || !tooltipsEl) return;

  const businessReservePct = Number(businessReservePctEl.value);
  const maintenancePct = Number(maintenancePctEl.value);

  // Guardrails (preferences only)
  const safe = {
    businessReservePct: isFinite(businessReservePct) ? Math.max(0, Math.min(40, businessReservePct)) : TMS_SETTINGS_DEFAULTS.businessReservePct,
    maintenancePct: isFinite(maintenancePct) ? Math.max(0, Math.min(40, maintenancePct)) : TMS_SETTINGS_DEFAULTS.maintenancePct,
    darkMode: !!darkModeEl.checked,
    tooltips: !!tooltipsEl.checked
  };

  localStorage.setItem(TMS_SETTINGS_STORAGE_KEY, JSON.stringify(safe));

  // Apply UI-only effects
  document.body.classList.toggle("darkMode", safe.darkMode);

  if (msgEl){
    msgEl.textContent = "‚úÖ Saved. (Preferences only ‚Äî math is locked.)";
  }
}

function resetSettingsPlainLock(){
  localStorage.setItem(TMS_SETTINGS_STORAGE_KEY, JSON.stringify(TMS_SETTINGS_DEFAULTS));
  loadSettingsPlainLock();
  const { msgEl } = getSettingsInputs();
  if (msgEl){
    msgEl.textContent = "‚ôªÔ∏è Reset to defaults. (Preferences only ‚Äî math is locked.)";
  }
}

// Load settings at startup (does not touch Scenario/Actual math)
document.addEventListener("DOMContentLoaded", () => {
  loadSettingsPlainLock();
});

// =====================
// üîí PLAIN LOCK TRIP v1.0 (DATA ENTRY ONLY)
// =====================
// Trip page is for miles entry + education only.
// It does NOT change Scenario/Actual formulas by itself.
// It may store and recall trip miles between sessions.

const TMS_TRIP_STORAGE_KEY = "TMS_TRIP_v1";

const TMS_TRIP_DEFAULTS = {
  deadheadMiles: 0,
  loadedMiles: 0,
  returnMiles: 0
};

// Safety caps (prevents wild typos)
const TMS_TRIP_LIMITS = {
  min: 0,
  max: 5000
};

function clampNumber(v, min, max){
  const num = Number(v);
  if (!isFinite(num)) return min;
  return Math.max(min, Math.min(max, num));
}

function getTripInputs(){
  return {
    deadheadEl: document.getElementById("deadheadMiles"),
    loadedEl: document.getElementById("loadedMiles"),
    returnEl: document.getElementById("returnMiles"),
    totalEl: document.getElementById("totalMiles"),
    msgEl: document.getElementById("tripSavedMsg")
  };
}

function readTripFromUI(){
  const { deadheadEl, loadedEl, returnEl } = getTripInputs();
  if (!deadheadEl || !loadedEl || !returnEl) return { ...TMS_TRIP_DEFAULTS };

  return {
    deadheadMiles: clampNumber(deadheadEl.value, TMS_TRIP_LIMITS.min, TMS_TRIP_LIMITS.max),
    loadedMiles: clampNumber(loadedEl.value,   TMS_TRIP_LIMITS.min, TMS_TRIP_LIMITS.max),
    returnMiles: clampNumber(returnEl.value,   TMS_TRIP_LIMITS.min, TMS_TRIP_LIMITS.max)
  };
}

function writeTripToUI(t){
  const { deadheadEl, loadedEl, returnEl } = getTripInputs();
  if (!deadheadEl || !loadedEl || !returnEl) return;

  deadheadEl.value = t.deadheadMiles;
  loadedEl.value   = t.loadedMiles;
  returnEl.value   = t.returnMiles;

  // Recalculate Total Miles using your existing function
  if (typeof updateTotalMilesFromParts === "function"){
    updateTotalMilesFromParts();
  }
}

function loadTripPlainLock(){
  let saved = null;
  try {
    saved = JSON.parse(localStorage.getItem(TMS_TRIP_STORAGE_KEY) || "null");
  } catch (e) {
    saved = null;
  }

  const t = { ...TMS_TRIP_DEFAULTS, ...(saved || {}) };

  // Clamp again in case storage had bad data
  const safe = {
    deadheadMiles: clampNumber(t.deadheadMiles, TMS_TRIP_LIMITS.min, TMS_TRIP_LIMITS.max),
    loadedMiles:   clampNumber(t.loadedMiles,   TMS_TRIP_LIMITS.min, TMS_TRIP_LIMITS.max),
    returnMiles:   clampNumber(t.returnMiles,   TMS_TRIP_LIMITS.min, TMS_TRIP_LIMITS.max)
  };

  writeTripToUI(safe);
  showTripWarningsPlainLock(safe);
}

function saveTripPlainLock(){
  const { msgEl } = getTripInputs();
  const safe = readTripFromUI();

  // Normalize UI to clamped values (so user sees the ‚Äútruth‚Äù)
  writeTripToUI(safe);

  localStorage.setItem(TMS_TRIP_STORAGE_KEY, JSON.stringify(safe));

  showTripWarningsPlainLock(safe);

  if (msgEl){
    msgEl.textContent = "‚úÖ Saved Trip miles. (Data entry only ‚Äî no math changed.)";
  }
}

function resetTripPlainLock(){
  localStorage.setItem(TMS_TRIP_STORAGE_KEY, JSON.stringify(TMS_TRIP_DEFAULTS));
  loadTripPlainLock();

  const { msgEl } = getTripInputs();
  if (msgEl){
    msgEl.textContent = "‚ôªÔ∏è Reset Trip miles to defaults.";
  }
}

// üîí Plain Lock Guardrail: warn if Return is unusually large
function showTripWarningsPlainLock(t){
  const { msgEl } = getTripInputs();
  if (!msgEl) return;

  // If return >= loaded and loaded > 0, show a confirmation-style warning
  if (t.loadedMiles > 0 && t.returnMiles >= t.loadedMiles){
    msgEl.textContent =
      "‚ö†Ô∏è Heads up: Return Miles is >= Loaded Miles. That may be correct ‚Äî just double-check.";
  }
}

// Auto-save on typing (Trip only)
document.addEventListener("DOMContentLoaded", () => {
  loadTripPlainLock();

  const { deadheadEl, loadedEl, returnEl } = getTripInputs();
  [deadheadEl, loadedEl, returnEl].forEach(el => {
    if (!el) return;
    el.addEventListener("input", () => {
      // Keep Total Miles live (you already do this oninput, but this is a safe fallback)
      if (typeof updateTotalMilesFromParts === "function"){
        updateTotalMilesFromParts();
      }
      // Save Trip entries without touching Scenario/Actual math
      saveTripPlainLock();
    });
  });
});

// =====================
// üîí PLAIN LOCK BUDGET v1.0 (DUAL LEDGER)
// =====================
const TMS_BUDGET_STORAGE_KEY = "TMS_BUDGET_v1";

const TMS_BUDGET_DEFAULTS = {
  // Household
  hhHousing: 0,
  hhUtilities: 0,
  hhFood: 0,
  hhInsurance: 0,
  hhPhoneInternet: 0,
  hhChildSupport: 0,
  hhTransport: 0,
  hhBuffer: 0,

  // Business
  bizTruckPayment: 0,
  bizInsurance: 0,
  bizPlatesPermits: 0,
  bizEldSubs: 0,
  bizAdmin: 0,
  bizMaintenanceReserve: 0,
  bizTireReserve: 0,
  bizBreakdownBuffer: 0
};

function numVal(id){
  const el = document.getElementById(id);
  if (!el) return 0;
  const v = Number(el.value);
  return isFinite(v) ? Math.max(0, v) : 0;
}

function setRO(id, v){
  const el = document.getElementById(id);
  if (!el) return;
  el.value = isFinite(v) ? v.toFixed(2) : "";
}

function getBudgetEls(){
  const ids = Object.keys(TMS_BUDGET_DEFAULTS);
  const map = {};
  ids.forEach(id => map[id] = document.getElementById(id));
  return map;
}

function readBudgetFromUI(){
  const data = {};
  Object.keys(TMS_BUDGET_DEFAULTS).forEach(id => {
    data[id] = numVal(id);
  });
  return data;
}

function writeBudgetToUI(b){
  Object.keys(TMS_BUDGET_DEFAULTS).forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = (b[id] ?? 0);
  });
}

function calcBudgetRollups(b){
  const hhMonthly =
    (b.hhHousing + b.hhUtilities + b.hhFood + b.hhInsurance +
     b.hhPhoneInternet + b.hhChildSupport + b.hhTransport + b.hhBuffer);

  const bizMonthly =
    (b.bizTruckPayment + b.bizInsurance + b.bizPlatesPermits + b.bizEldSubs +
     b.bizAdmin + b.bizMaintenanceReserve + b.bizTireReserve + b.bizBreakdownBuffer);

  const hhWeekly = hhMonthly / 4.333;  // avg weeks per month
  const bizWeekly = bizMonthly / 4.333;

  const hhDaily = hhMonthly / 30.0;    // simple v1.0 baseline
  const bizDaily = bizMonthly / 30.0;

  const hhHourlyAway = hhDaily / 24.0; // per hour away from home
  const bizHourlyAway = bizDaily / 24.0;

  const combinedMonthly = hhMonthly + bizMonthly;
  const combinedHourlyAway = hhHourlyAway + bizHourlyAway;

  return {
    hhMonthly, hhWeekly, hhDaily, hhHourlyAway,
    bizMonthly, bizWeekly, bizDaily, bizHourlyAway,
    combinedMonthly, combinedHourlyAway
  };
}

function renderBudgetRollups(){
  const b = readBudgetFromUI();
  const r = calcBudgetRollups(b);

  setRO("hhTotalMonthly", r.hhMonthly);
  setRO("hhTotalWeekly", r.hhWeekly);
  setRO("hhTotalDaily", r.hhDaily);
  setRO("hhTotalHourlyAway", r.hhHourlyAway);

  setRO("bizTotalMonthly", r.bizMonthly);
  setRO("bizTotalWeekly", r.bizWeekly);
  setRO("bizTotalDaily", r.bizDaily);
  setRO("bizTotalHourlyAway", r.bizHourlyAway);

  setRO("budgetCombinedMonthly", r.combinedMonthly);
  setRO("budgetCombinedHourlyAway", r.combinedHourlyAway);
}

function loadBudgetPlainLock(){
  let saved = null;
  try {
    saved = JSON.parse(localStorage.getItem(TMS_BUDGET_STORAGE_KEY) || "null");
  } catch (e) {
    saved = null;
  }

  const b = { ...TMS_BUDGET_DEFAULTS, ...(saved || {}) };

  // clamp to >= 0
  Object.keys(b).forEach(k => {
    const v = Number(b[k]);
    b[k] = isFinite(v) ? Math.max(0, v) : 0;
  });

  writeBudgetToUI(b);
  renderBudgetRollups();
}

function saveBudgetPlainLock(){
  const msgEl = document.getElementById("budgetSavedMsg");
  const b = readBudgetFromUI();
  localStorage.setItem(TMS_BUDGET_STORAGE_KEY, JSON.stringify(b));
  renderBudgetRollups();
  if (msgEl) msgEl.textContent = "‚úÖ Saved Budget (Household + Business).";
}

function resetBudgetPlainLock(){
  const msgEl = document.getElementById("budgetSavedMsg");
  localStorage.setItem(TMS_BUDGET_STORAGE_KEY, JSON.stringify(TMS_BUDGET_DEFAULTS));
  loadBudgetPlainLock();
  if (msgEl) msgEl.textContent = "‚ôªÔ∏è Reset Budget to defaults.";
}

// Live rollups as you type
document.addEventListener("DOMContentLoaded", () => {
  loadBudgetPlainLock();

  Object.keys(TMS_BUDGET_DEFAULTS).forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener("input", () => {
      renderBudgetRollups();
    });
  });
});
    
// =====================
// üîí PLAIN LOCK ACTUAL v1.0 (TRUTH ONLY)
// =====================
// RULES (LOCKED):
// 1) Actual does not unlock until Status = Delivered.
// 2) Actual writes to Actual storage + Lifetime MPG only.
// 3) Scenario never writes into Actual.
// 4) Actual may update lifetime MPG used by Scenario (read-only there).

const TMS_ACTUAL_STORAGE_KEY = "TMS_ACTUAL_v1";
const TMS_ACTUAL_HISTORY_KEY = "TMS_ACTUAL_HISTORY_v1";      // optional: store trips list
const TMS_LIFETIME_MPG_KEY   = "TMS_LIFETIME_MPG_v1";

const TMS_ACTUAL_DEFAULTS = {
  status: "Locked (Not Delivered)",
  deliveredAt: "",
  revenue: 0,
  deadhead: 0,
  loaded: 0,
  rtn: 0,
  gallons: 0,
  fuelPrice: 0,
  detentionHours: 0
};

// caps prevent wild typos (same spirit as Trip caps)
const TMS_ACTUAL_LIMITS = {
  milesMin: 0,
  milesMax: 8000,
  moneyMin: 0,
  moneyMax: 100000,
  gallonsMin: 0,
  gallonsMax: 3000,
  fuelPriceMin: 0,
  fuelPriceMax: 10,
  hoursMin: 0,
  hoursMax: 72
};

function clamp(v, min, max){
  const n = Number(v);
  if (!isFinite(n)) return min;
  return Math.max(min, Math.min(max, n));
}

function getActualEls(){
  return {
    statusEl: document.getElementById("actStatus"),
    deliveredAtEl: document.getElementById("actDeliveredAt"),
    revenueEl: document.getElementById("actRevenue"),
    deadheadEl: document.getElementById("actDeadhead"),
    loadedEl: document.getElementById("actLoaded"),
    returnEl: document.getElementById("actReturn"),
    totalMilesEl: document.getElementById("actTotalMiles"),
    gallonsEl: document.getElementById("actGallons"),
    fuelPriceEl: document.getElementById("actFuelPrice"),
    detentionEl: document.getElementById("actDetentionHours"),
    fuelCostEl: document.getElementById("actFuelCost"),
    lifetimeMPGEl: document.getElementById("actLifetimeMPG"),
    gateMsgEl: document.getElementById("actualGateMsg"),
    savedMsgEl: document.getElementById("actualSavedMsg"),
    msgEl: document.getElementById("actualMessage")
  };
}

function isDelivered(a){
  return a.status === "Delivered";
}

function setActualInputsEnabled(enabled){
  const {
    revenueEl, deadheadEl, loadedEl, returnEl,
    gallonsEl, fuelPriceEl, detentionEl
  } = getActualEls();

  [revenueEl, deadheadEl, loadedEl, returnEl, gallonsEl, fuelPriceEl, detentionEl]
    .forEach(el => { if (el) el.disabled = !enabled; });
}

function readActualFromUI(){
  const {
    statusEl, deliveredAtEl, revenueEl, deadheadEl, loadedEl, returnEl,
    gallonsEl, fuelPriceEl, detentionEl
  } = getActualEls();

  const status = statusEl?.value || TMS_ACTUAL_DEFAULTS.status;
  const deliveredAt = deliveredAtEl?.value || "";

  return {
    status,
    deliveredAt,
    revenue: clamp(revenueEl?.value, TMS_ACTUAL_LIMITS.moneyMin, TMS_ACTUAL_LIMITS.moneyMax),
    deadhead: clamp(deadheadEl?.value, TMS_ACTUAL_LIMITS.milesMin, TMS_ACTUAL_LIMITS.milesMax),
    loaded: clamp(loadedEl?.value, TMS_ACTUAL_LIMITS.milesMin, TMS_ACTUAL_LIMITS.milesMax),
    rtn: clamp(returnEl?.value, TMS_ACTUAL_LIMITS.milesMin, TMS_ACTUAL_LIMITS.milesMax),
    gallons: clamp(gallonsEl?.value, TMS_ACTUAL_LIMITS.gallonsMin, TMS_ACTUAL_LIMITS.gallonsMax),
    fuelPrice: clamp(fuelPriceEl?.value, TMS_ACTUAL_LIMITS.fuelPriceMin, TMS_ACTUAL_LIMITS.fuelPriceMax),
    detentionHours: clamp(detentionEl?.value, TMS_ACTUAL_LIMITS.hoursMin, TMS_ACTUAL_LIMITS.hoursMax)
  };
}

function writeActualToUI(a){
  const {
    statusEl, deliveredAtEl, revenueEl, deadheadEl, loadedEl, returnEl,
    totalMilesEl, gallonsEl, fuelPriceEl, detentionEl
  } = getActualEls();

  if (statusEl) statusEl.value = a.status || TMS_ACTUAL_DEFAULTS.status;
  if (deliveredAtEl) deliveredAtEl.value = a.deliveredAt || "";

  if (revenueEl) revenueEl.value = a.revenue ?? 0;
  if (deadheadEl) deadheadEl.value = a.deadhead ?? 0;
  if (loadedEl) loadedEl.value = a.loaded ?? 0;
  if (returnEl) returnEl.value = a.rtn ?? 0;

  const totalMiles = (a.deadhead ?? 0) + (a.loaded ?? 0) + (a.rtn ?? 0);
  if (totalMilesEl) totalMilesEl.value = totalMiles;

  if (gallonsEl) gallonsEl.value = a.gallons ?? 0;
  if (fuelPriceEl) fuelPriceEl.value = a.fuelPrice ?? 0;
  if (detentionEl) detentionEl.value = a.detentionHours ?? 0;
}

function calcActualOutputs(a){
  const { fuelCostEl, lifetimeMPGEl, msgEl } = getActualEls();

  const totalMiles = a.deadhead + a.loaded + a.rtn;
  const fuelCost = (a.gallons > 0 && a.fuelPrice > 0) ? (a.gallons * a.fuelPrice) : 0;
  if (fuelCostEl) fuelCostEl.value = fuelCost ? fuelCost.toFixed(2) : "";

  const lifetimeMPG = getLifetimeMPGPlainLock();
  if (lifetimeMPGEl) lifetimeMPGEl.value = isFinite(lifetimeMPG) && lifetimeMPG > 0 ? lifetimeMPG.toFixed(2) : "";

  if (msgEl){
    if (!isDelivered(a)){
      msgEl.textContent = "üîí Locked: Mark Delivered to unlock Actual entry.";
    } else if (totalMiles <= 0){
      msgEl.textContent = "Enter Actual miles to update truth.";
    } else {
      msgEl.textContent = "‚úÖ Actual saved = truth. (Scenario remains separate.)";
    }
  }
}

function loadActualPlainLock(){
  const { gateMsgEl, savedMsgEl } = getActualEls();

  let saved = null;
  try {
    saved = JSON.parse(localStorage.getItem(TMS_ACTUAL_STORAGE_KEY) || "null");
  } catch (e) {
    saved = null;
  }

  const a = { ...TMS_ACTUAL_DEFAULTS, ...(saved || {}) };

  // clamp safe
  const safe = {
    status: a.status || TMS_ACTUAL_DEFAULTS.status,
    deliveredAt: a.deliveredAt || "",
    revenue: clamp(a.revenue, TMS_ACTUAL_LIMITS.moneyMin, TMS_ACTUAL_LIMITS.moneyMax),
    deadhead: clamp(a.deadhead, TMS_ACTUAL_LIMITS.milesMin, TMS_ACTUAL_LIMITS.milesMax),
    loaded: clamp(a.loaded, TMS_ACTUAL_LIMITS.milesMin, TMS_ACTUAL_LIMITS.milesMax),
    rtn: clamp(a.rtn, TMS_ACTUAL_LIMITS.milesMin, TMS_ACTUAL_LIMITS.milesMax),
    gallons: clamp(a.gallons, TMS_ACTUAL_LIMITS.gallonsMin, TMS_ACTUAL_LIMITS.gallonsMax),
    fuelPrice: clamp(a.fuelPrice, TMS_ACTUAL_LIMITS.fuelPriceMin, TMS_ACTUAL_LIMITS.fuelPriceMax),
    detentionHours: clamp(a.detentionHours, TMS_ACTUAL_LIMITS.hoursMin, TMS_ACTUAL_LIMITS.hoursMax)
  };

  writeActualToUI(safe);

  // lock gate
  setActualInputsEnabled(isDelivered(safe));
  if (gateMsgEl){
    gateMsgEl.textContent = isDelivered(safe)
      ? "‚úÖ Unlocked: Delivered confirmed."
      : "üîí Locked until Delivered.";
  }
  if (savedMsgEl) savedMsgEl.textContent = "";

  calcActualOutputs(safe);
}

function saveActualPlainLock(){
  const { savedMsgEl, gateMsgEl } = getActualEls();
  const a = readActualFromUI();

  // HARD FENCE: must be delivered
  if (!isDelivered(a)){
    if (savedMsgEl) savedMsgEl.textContent = "üîí Cannot save Actual: Status is not Delivered.";
    if (gateMsgEl) gateMsgEl.textContent = "Tap ‚úÖ Mark Delivered to unlock Actual.";
    setActualInputsEnabled(false);
    return;
  }

  // normalize + write UI truth
  writeActualToUI(a);

  // update Lifetime MPG (from this saved trip, plus optional history)
  commitActualToHistoryAndLifetimeMPG(a);

  localStorage.setItem(TMS_ACTUAL_STORAGE_KEY, JSON.stringify(a));

  if (savedMsgEl){
    savedMsgEl.textContent = "‚úÖ Saved Actual (Truth only). Lifetime MPG updated.";
  }

  calcActualOutputs(a);
}

function resetActualPlainLock(){
  localStorage.setItem(TMS_ACTUAL_STORAGE_KEY, JSON.stringify(TMS_ACTUAL_DEFAULTS));
  loadActualPlainLock();
  const { savedMsgEl } = getActualEls();
  if (savedMsgEl) savedMsgEl.textContent = "‚ôªÔ∏è Reset Actual (still locked until Delivered).";
}

function markDeliveredPlainLock(){
  const { statusEl, deliveredAtEl, gateMsgEl, savedMsgEl } = getActualEls();
  if (!statusEl || !deliveredAtEl) return;

  statusEl.value = "Delivered";
  deliveredAtEl.value = new Date().toLocaleString();

  setActualInputsEnabled(true);

  if (gateMsgEl) gateMsgEl.textContent = "‚úÖ Delivered confirmed. Actual unlocked.";
  if (savedMsgEl) savedMsgEl.textContent = "Now enter Actual truth and tap Save.";

  // persist the gate immediately (so reload stays unlocked)
  const a = readActualFromUI();
  a.status = "Delivered";
  a.deliveredAt = deliveredAtEl.value;
  localStorage.setItem(TMS_ACTUAL_STORAGE_KEY, JSON.stringify(a));

  calcActualOutputs(a);
}

// ----- Lifetime MPG (LOCKED FEED FOR SCENARIO) -----
function getLifetimeMPGPlainLock(){
  let saved = null;
  try {
    saved = JSON.parse(localStorage.getItem(TMS_LIFETIME_MPG_KEY) || "null");
  } catch (e) {
    saved = null;
  }
  const mpg = Number(saved?.mpg);
  return isFinite(mpg) ? mpg : 0;
}

// Stores history as [{ totalMiles, gallons, deliveredAt }]
function commitActualToHistoryAndLifetimeMPG(a){
  const totalMiles = a.deadhead + a.loaded + a.rtn;
  const gallons = a.gallons;

  if (!(totalMiles > 0 && gallons > 0)) return;

  let hist = [];
  try {
    hist = JSON.parse(localStorage.getItem(TMS_ACTUAL_HISTORY_KEY) || "[]");
    if (!Array.isArray(hist)) hist = [];
  } catch (e) {
    hist = [];
  }

  // add one record (simple v1.0)
  hist.push({
    totalMiles,
    gallons,
    deliveredAt: a.deliveredAt || new Date().toISOString()
  });

  // keep history from exploding (cap to last 200)
  if (hist.length > 200) hist = hist.slice(hist.length - 200);

  localStorage.setItem(TMS_ACTUAL_HISTORY_KEY, JSON.stringify(hist));

  // compute lifetime mpg
  let milesSum = 0;
  let gallonsSum = 0;
  hist.forEach(r => {
    milesSum += Number(r.totalMiles) || 0;
    gallonsSum += Number(r.gallons) || 0;
  });

  const mpg = gallonsSum > 0 ? (milesSum / gallonsSum) : 0;

  localStorage.setItem(TMS_LIFETIME_MPG_KEY, JSON.stringify({
    mpg,
    milesSum,
    gallonsSum,
    updatedAt: new Date().toISOString()
  }));

  // OPTIONAL: also update your Scenario placeholder object safely
  // so Scenario can read Lifetime MPG as a locked value later.
  if (typeof SCENARIO_PLAIN_CODE === "object" && SCENARIO_PLAIN_CODE){
    // Scenario must treat this as read-only; it‚Äôs a feed from Actual truth.
    SCENARIO_PLAIN_CODE.lifetimeMPG = mpg || SCENARIO_PLAIN_CODE.lifetimeMPG;
  }
}

// Live total miles update on Actual typing (even before save)
function updateActualTotalMilesUI(){
  const { deadheadEl, loadedEl, returnEl, totalMilesEl } = getActualEls();
  if (!deadheadEl || !loadedEl || !returnEl || !totalMilesEl) return;

  const total = (Number(deadheadEl.value)||0) + (Number(loadedEl.value)||0) + (Number(returnEl.value)||0);
  totalMilesEl.value = total;
}

// Init
document.addEventListener("DOMContentLoaded", () => {
  loadActualPlainLock();

  const { deadheadEl, loadedEl, returnEl, revenueEl, gallonsEl, fuelPriceEl, detentionEl } = getActualEls();
  [deadheadEl, loadedEl, returnEl, revenueEl, gallonsEl, fuelPriceEl, detentionEl].forEach(el => {
    if (!el) return;
    el.addEventListener("input", () => {
      updateActualTotalMilesUI();
      // outputs can refresh live without saving
      const a = readActualFromUI();
      writeActualToUI(a);
      calcActualOutputs(a);
    });
  });
});
  </script>

</body>
</html>
